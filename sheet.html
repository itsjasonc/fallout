<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>FALLOUT CHARACTER SHEET</title>

  <style>
    body { overflow-x: hidden; width: 100%; margin:0; padding:0; font-family: monospace; background:#0b120b; color:#9fef9f; }
    .app { max-width:900px; margin:auto; padding:12px; background:#0f1f0f; box-shadow:0 0 20px #0f0; }
    h2 { color:#7cff7c; text-shadow:0 0 6px #0f0;  }
    .grid { display:grid; gap:8px; }
    .title { grid-template-columns:75% 23%; }

    input, textarea {
      background:#081408; color:#9fef9f;
      border:1px solid #2cff2c; padding:6px;
      font-family:monospace; width:100%; box-sizing:border-box;
    }

    .card { background:#081408; border:1px solid #2cff2c; padding:8px; }
    .center { text-align:center; }

    .stats, .armor, .hp-area, .negatives, .inventory {
      margin:10px 0;
    }

    .stats { grid-template-columns: repeat(5, 1fr); }
    .stat-box input { text-align:center; font-size:18px; }
	
	.grid.title.card {
	  margin-top: 10px; /* adjust to taste */
	}
	
	
    .armor {
      display:flex;
      flex-direction:row;
      gap:8px;
      flex-wrap:nowrap;
    }

    .armor-box {
      flex:1 1 0;
      min-width:0;
      box-sizing:border-box;
      padding:10px;
      border: 2px solid;
      display:flex;
      flex-direction:column;
      justify-content:center;
      align-items:center;
    }
	
	
    .armor-label {
      font-weight:bold;
      margin-bottom:6px;
      display:block;
      font-size:clamp(10px, 2.5vw, 16px);
    }

    .p-theme { background:#331111; border-color:#ff5c5c; }
    .e-theme { background:#112233; border-color:#5ca9ff; }
    .x-theme { background:#332211; border-color:#ffb85c; }
    .r-theme { background:#113311; border-color:#6dff6d; }
	
	/* Physical */
	.armor-box.p-theme input {
	  color: #ff5c5c;
	  border-color: #ff5c5c;
	}

	/* Energy */
	.armor-box.e-theme input {
	  color: #5ca9ff;
	  border-color: #5ca9ff;
	}

	/* Explosive */
	.armor-box.x-theme input {
	  color: #ffb85c;
	  border-color: #ffb85c;
	}

	/* Rad */
	.armor-box.r-theme input {
	  color: #6dff6d;
	  border-color: #6dff6d;
	}

    .armor-box input {
      text-align:center;
      font-size:clamp(14px, 4vw, 22px);
      font-weight:bold;
      background:transparent;
      border:none;
      color: var(--armor-color);
		border: 1px solid var(--armor-color);
    }
	

    .hp-area {
      display:grid;
      grid-template-columns: 1fr 72px;
      gap:8px;
      align-items:stretch;
      margin:10px 0;
    }

    .hp-box {
      position:relative;
      height:180px;
      display:flex;
      flex-direction:column;
      align-items:center;
      padding-top:6px;
    }

    .hp-title {
      font-size:20px;
      letter-spacing:2px;
      margin-bottom:4px;
    }

    .hp-center {
      flex:1;
      display:flex;
      align-items:center;
      justify-content:center;
      position:relative;
      width:100%;
    }

    .hp-btn {
  position:absolute;
  top:50%;
  transform:translateY(-50%);
  font-size: clamp(18px, 4vw, 28px);
  background:#081408;
  color:#9fef9f;
  border:1px solid #2cff2c;
  padding: clamp(2px, 0.5vw, 4px) clamp(6px, 1vw, 12px);
}
    .hp-minus { left:8px; }
    .hp-plus { right:8px; }

    .hp-plus10 {
  position: absolute;
  right: 4px;          /* move right */
  top: 1%;            /* move upward */
  transform: translateY(-50%);
  font-size: clamp(14px, 3vw, 20px);
  padding: clamp(2px, 0.5vw, 4px) clamp(4px, 1vw, 8px);
  background:#081408;
  color:#9fef9f;
  border:1px solid #2cff2c;
  box-shadow:0 0 6px #2cff2c;
}

.hp-dmgbox {
  position: absolute;
  top: 1%;
  left: 6px;
  padding: 0;
  background: #081408;            /* dark Pip‑Boy background */
  border: 1px solid #ff3c3c;      /* dark red outline */
  box-shadow: 0 0 6px #ff3c3c;    /* matching glow */
}

.armor-dmg-input {
  width: 40px;
  background: transparent !important;   /* force override */
  border: none !important;              /* remove border */
  outline: none !important;             /* remove focus ring */
  -webkit-appearance: none !important;  /* remove iOS/Chrome styling */
  -moz-appearance: none !important;     /* remove Firefox styling */
  appearance: none !important;          /* remove generic styling */
  color: #9fef9f;
  font-size: clamp(12px, 2.5vw, 18px);
  text-align: center;
  padding: 0;
  margin: 0;
}
	
	#hp {
      font-size:42px;
      text-align:center;
      width:160px;
      background:#081408;
      border:1px solid #2cff2c;
      padding:4px;
    }

    .hp-lower-row {
      display:flex;
      flex-direction:row;
      align-items:center;
      justify-content:center;
      gap:12px;
      margin-top:6px;
    }
	
	

    .addiction-box {
      width:110px;
      text-align:center;
      cursor:pointer;
      background:#081408;
      border-color:#2cff2c;
      color:#9fef9f;
      box-shadow:none;
    }

    .withdraw-box {
      display:flex;
      align-items:center;
      justify-content:center;
    }

    .withdraw-box input {
  appearance: none;
  width: 20px;
  height: 20px;
  border: 1px solid #2cff2c;
  background: #081408;
  cursor: pointer;
  position: relative;
  box-shadow: 0 0 4px #2cff2c;
}

.withdraw-box input:checked {
  background: #0f2f0f;
  border-color: #2cff2c;
  box-shadow: 0 0 6px #2cff2c;
}

.withdraw-box input:checked::after {
  content: "X";
  position: absolute;
  top: -1px;
  left: 4px;
  font-size: 18px;
  font-weight: bold;
  color: #2cff2c;
}

    .uses {
      display:grid;
      grid-template-rows: repeat(3, 1fr);
      gap:6px;
	  transform: translateX(-4px); /* move left without resizing */
    }

    .use-box {
      display:flex; align-items:center; justify-content:center;
      font-weight:bold; cursor:pointer; user-select:none;
      border:1px solid; padding:6px;
    }
    .use-on { background:#0f2f0f; border-color:#2cff2c; box-shadow:0 0 8px #2cff2c; }
    .use-off { background:#2a0000; border-color:#ff3c3c; color:#ff9c9c; box-shadow:0 0 8px #ff3c3c; }

    .negatives { grid-template-columns: repeat(5, 1fr); }
    .neg-card { text-align:center; min-width:0; padding:4px; }
    .neg-value { font-size:22px; }
    .neg-btn-row { display:flex; justify-content:center; gap:4px; }
    .neg-btn { padding:1px 4px; background:#081408; color:#9fef9f; border:1px solid #2cff2c; font-size:14px; }

    .inventory { grid-template-columns:1fr; }
    .slot {
  display:flex;
  flex-direction:column;
  gap:6px;
  background:#040a04;        /* darker than inside */
  border:1px solid #2cff2c;
  padding:6px;
}


    .slot-top {
      display:grid;
      grid-template-columns: 32px 1fr 36px;
      gap:6px;
      height:4.5em;
      align-items:stretch;
    }

    .slot textarea {
  flex:1;
  resize:none;
  font-size: clamp(12px, 3vw, 16px);   /* inventory text size */
  line-height: 1.3em;                  /* more breathing room */
  min-height: 3.2em;                   /* ensures 2 rows fit cleanly */
}


    .heavy-toggle {
      width: 36px;
      height: 100%;
      border: 1px solid #2cff2c;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      position: relative;
      background: #081408;
      transition: background 0.2s, border-color 0.2s;
    }

    .heavy-toggle::before {
      content: "H";
      font-size: 26px;
      color: rgba(255, 0, 0, 0.25);
      position: absolute;
    }

    .heavy-on {
      border-color: #ff3c3c;
      background: #2a0000;
      box-shadow: 0 0 8px #ff3c3c;
    }

    .heavy-on::before {
      color: #ff3c3c;
    }

    .dropdown-toggle {
      cursor:pointer;
      font-size:18px;
      padding:2px 0;
      border:1px solid #2cff2c;
      background:#081408;
      color:#9fef9f;
      width:32px;
      text-align:center;
      user-select:none;
      display:flex;
      align-items:center;
      justify-content:center;
    }

    .dropdown-area {
  display:none;
  padding:0;
  border:none;
  background:transparent;
}


    .dropdown-area.open {
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap:8px;
    }

    .inv-counter-card { padding:4px; }

    .neg-title-input {
      width:100%;
      background:#081408;
      border:1px solid #2cff2c;
      color:#9fef9f;
      padding:2px 4px;
      text-align:center;
      margin-bottom:2px;
      font-weight:bold;
    }

    .inv-counter-btn-row {
      display:flex;
      justify-content:center;
      align-items:center;
      gap:6px;
    }

    .inv-counter-value {
      font-size:28px;
      padding:0 6px;
      text-align:center;
      min-width:40px;
    }

    .inv-counter-btn {
      padding:1px 4px;
      background:#081408;
      color:#9fef9f;
      border:1px solid #2cff2c;
      font-size:14px;
      cursor:pointer;
    }
	
/* Top-right button */
.perks-btn {
  background:#081408;
  color:#9fef9f;
  border:1px solid #2cff2c;
  padding:4px 10px;
  font-family:monospace;
  cursor:pointer;
  box-shadow:0 0 6px #2cff2c;
  margin-right: 16px; /* ← move left slightly */
}


/* Back button */
.back-btn {
  background:#081408;
  color:#9fef9f;
  border:1px solid #2cff2c;
  padding:4px 10px;
  font-family:monospace;
  cursor:pointer;
  
  box-shadow:0 0 6px #2cff2c;
  margin-bottom:10px;
}

.hidden-screen {
  display:none;
  position:fixed;
  top:0;
  left:0;
  width:100%;
  height:100%;
  background:#081408;
  overflow-y:auto;
  z-index:999;
  color:#9fef9f;
}


.perks-content h3 {
  margin-top:20px;
  color:#9fef9f;
}

.title-bar {
  display: flex;
  justify-content: space-between;
  align-items: center;
  width: 100%;
  max-width: 900px;
  margin: 0 auto;
  padding: 0; /* no horizontal padding */
}

.title-bar h2 { margin-left: 16px; }

.title-left {
  width: 300px;   /* ensures both titles occupy the same space */
}

#backBtn {
  margin-right: 16px; /* move SHEET left — adjust value as needed */
}

.perk-header {
  display: flex;
  align-items: center;
  gap: 8px;
  max-width: 100%;
  overflow: hidden;
  margin-left: 16px; /* match major-header */
}

.perk-header h3 {
  margin: 0;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}


.perk-header .triangle {
  font-size: 16px;
  transition: transform 0.2s;
}

/* When collapsed, rotate triangle to point right */
.perk-header.collapsed .triangle {
  transform: rotate(-90deg);
}

/* Collapsible content */
.perk-list {
  display: none;
  margin-left: 20px;
}

.perk-list.open {
  display: block;
}


.collapse-arrow {
  transition: transform 0.2s;
}

.collapse-arrow.open {
  transform: rotate(180deg);
}


.perk-item {
  display: flex;
  align-items: center;
  gap: 10px;
  width: 100%;
  max-width: 100%;
  flex-wrap: wrap;
  margin-top: 8px; /* adjust to taste */
}

.perk-text {
  flex: 1;
  min-width: 0; /* CRITICAL */
  overflow-wrap: break-word;
}


.perk-item input {
  display: none;
}

.perk-box {
  width: 18px;
  height: 18px;
  border: 2px solid #2cff2c;
  box-shadow: 0 0 6px #2cff2c;
  position: relative;
}

.perk-check:checked + .perk-box::after {
  content: "✔";
  color: #9fef9f;
  font-size: 16px;
  position: absolute;
  top: -2px;
  left: 1px;
  text-shadow: 0 0 6px #0f0;
}

/* Highlight the whole perk row when selected */
.perk-check:checked ~ .perk-text,
.perk-check:checked ~ .perk-box {
  background: rgba(44, 255, 44, 0.12); /* soft green glow */
  box-shadow: 0 0 6px #2cff2c;
}



#perksScreen,
.perks-content,
#mainScreen {
  max-width: 100%;
  overflow-x: hidden;
}
.perk-section {
  margin-bottom: 10px; /* adjust to taste */
}

#specialWrapper.collapsed {
  display: none;
}

.major-header {
  display: flex;
  align-items: center;
  gap: 8px;
  cursor: pointer;
  color: #9fef9f;
  text-shadow: 0 0 6px #0f0;
  margin-left: 16px; /* same as your Perks title */
}

.major-header .triangle {
  font-size: 18px;
  transition: transform 0.2s;
}

.major-header.collapsed .triangle {
  transform: rotate(-90deg);
}

#notesWrapper {
  
  padding-right: 16px;
	
  
}
#notesHeader {
  margin-top: 32px;
}

.nav-btn {
    margin-right: 18px;
}

.stat-starred {
  color: #ffd966;
  text-shadow: 0 0 3px #ffd966;
  letter-spacing: -1px;
  white-space: nowrap;
}

.stat-starred::before,
.stat-starred::after {
  font-size: 0.75em;
  vertical-align: middle;
}



  </style>
</head>

<body>

<div class="title-bar">
  <div class="title-left"><h2>FALLOUT CHARACTER SHEET</h2></div>
  <button id="perksBtn" class="perks-btn">PERKS</button>
</div>

  <div class="grid title card">
 
    <input id="name" placeholder="CHARACTER NAME">
    <input id="skillName" placeholder="LEVEL">
    <input id="level" placeholder="SKILL">
    <input id="caps" placeholder="CAPS">
  </div>
  
  

  <div class="grid stats" id="stats"></div>

  <div class="armor" id="armor"></div>

  <div class="hp-area">
    <div class="card hp-box">
      <div class="hp-title">HIT POINTS</div>

      <div class="hp-center">
        <button class="hp-btn hp-minus" onclick="chgHP(-1)">−</button>
		<input id="hp">
		<button class="hp-btn hp-plus" onclick="chgHP(1)">+</button>
		<button class="hp-btn hp-plus10" onclick="chgHP10()">+10%</button>
		<button class="hp-btn hp-dmgbox">
		<input id="armorDmgInput" class="armor-dmg-input" placeholder="3P"></button>
      </div>
	  

      <div class="hp-lower-row">
        <div id="addictionToggle" class="use-box addiction-box">ADDICTED</div>

        <label class="withdraw-box">
          <input type="checkbox" id="withdraw1">
        </label>

        <label class="withdraw-box">
          <input type="checkbox" id="withdraw2">
        </label>
      </div>
    </div>

    <div class="uses">
      <div id="useSkill" class="use-box">SKILL</div>
      <div id="useLuck" class="use-box">LUCK</div>
      <div id="useResist" class="use-box">RESIST</div>
    </div>
  </div>

  <div class="grid negatives" id="negatives"></div>

  <div class="grid inventory" id="inventory"></div>
</div>

<div id="perksScreen" class="hidden-screen">
  <div class="title-bar">
  <div class="title-left"><h2 id="perksTitle" class="major-header"> <span class="triangle">▼</span> PERKS </h2></div>
  <button class="perks-btn" onclick="exportSheet()">SAVE</button> 
  <button class="perks-btn" onclick="importSheet()">LOAD</button>
  <button id="backBtn" class="perks-btn">SHEET</button>
  <input type="file" id="fileInput" style="display:none" />
</div>

  <div class="perks-content">
      </div>
</div>


<script>

const STORAGE_KEY = "fallout_character_v10";
const statNames = ["STR","AGI","END","INT","CHA"];
const armorTypes = [
  ["Physical","p"],
  ["Energy","n"],
  ["Explosive","x"],
  ["Rad","r"]
];
const negNames = ["Hunger","Thirst","Fatigue","Rads","Injury"];

let state = JSON.parse(localStorage.getItem(STORAGE_KEY)) || {
  name: "",
  skillName: "",
  level: "",
  caps: "",
  hp: "20/20",
  perks: {},          // perk checkbox states
  perkSections: {},   // perk section open/closed
  stats: Object.fromEntries(statNames.map(s => [s, ""])),
  specialStats: Object.fromEntries(statNames.map(s => [s, false])),
  armor: { Physical:"", Energy:"", Explosive:"", Rad:"" },
  neg: Object.fromEntries(negNames.map(n => [n, 0])),
  inventory: Array.from({length:12}, () => ({
    name: "",
    heavy: false,
    dropdown: false,
    counters: [
      { title:"", value:0 },
      { title:"", value:0 },
      { title:"", value:0 }
    ]
  })),
  uses: { skill:false, luck:false, resist:false },
  addiction: false,
  withdraw1: false,
  withdraw2: false,
  starredStats: Object.fromEntries(statNames.map(s => [s, false]))
};
state.starredStats = state.starredStats || Object.fromEntries(statNames.map(s => [s, false]));


function toggleSpecial(stat, el) {
  state.specialStats[stat] = !state.specialStats[stat];
  el.classList.toggle('stat-special', state.specialStats[stat]);
  save();
}

// Ensure new keys exist even for older saves
if (!state.perks) state.perks = {};
if (!state.perkSections) state.perkSections = {};

// ---------- SAVE / LOAD ----------

function save() {
  localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
}

// ---------- HP / NEGATIVES ----------

function parseHP() {
  const parts = state.hp.split("/");
  let cur = parseInt(parts[0]) || 0;
  let max = parseInt(parts[1]) || cur;
  return { cur, max };
}

function updateHPDisplay() {
  hp.value = state.hp;
}

function updateHPColor() {
  const hpEl = document.getElementById("hp");
  const { cur, max } = parseHP();
  const pct = max ? cur / max : 0;

  if (pct <= 0.25) {
    hpEl.style.color = "#ff3b3b";
    hpEl.style.textShadow = "0 0 6px #ff3b3b";
  } else if (pct <= 0.50) {
    hpEl.style.color = "#ff7f3f";
    hpEl.style.textShadow = "0 0 6px #ff7f3f";
  } else if (pct <= 0.75) {
    hpEl.style.color = "#e6ff66";
    hpEl.style.textShadow = "0 0 6px #e6ff66";
  } else {
    hpEl.style.color = "#9fef9f";
    hpEl.style.textShadow = "0 0 6px #9fef9f";
  }
}

function chgHP(d) {
  let { cur, max } = parseHP();
  cur = Math.max(0, Math.min(max, cur + d));
  state.hp = `${cur}/${max}`;
  updateHPDisplay();
  updateHPColor();
  save();
}

function chgHP10() {
  let { cur, max } = parseHP();
  let amount = Math.ceil(max * 0.10);
  cur = Math.min(max, cur + amount);
  state.hp = `${cur}/${max}`;
  updateHPDisplay();
  updateHPColor();
  save();
}

function chgNeg(n, d) {
  state.neg[n] = Math.max(0, state.neg[n] + d);
  const el = document.getElementById(n);
  const val = state.neg[n];

  el.innerText = val;

  // Color tiers
  if (val >= 8) {
    el.style.color = "#ff4c4c";     // red
  } else if (val >= 6) {
    el.style.color = "#ff7f3f";     // HP orange (redder orange)
  } else if (val >= 4) {
    el.style.color = "#ffd84d";     // yellow
  } else {
    el.style.color = "#9fef9f";     // green
  }

  save();
}




// ---------- INVENTORY ----------

function toggleHeavy(i) {
  state.inventory[i].heavy = !state.inventory[i].heavy;
  save();
  renderHeavy(i);
}

function renderHeavy(i) {
  const el = document.getElementById("heavy" + i);
  if (!el) return;
  if (state.inventory[i].heavy) {
    el.classList.add("heavy-on");
  } else {
    el.classList.remove("heavy-on");
  }
}

function toggleDropdown(i) {
  state.inventory[i].dropdown = !state.inventory[i].dropdown;
  save();
  renderDropdown(i);
}

function renderDropdown(i) {
  const area = document.getElementById("droparea" + i);
  const toggle = document.getElementById("dropbtn" + i);
  if (!area || !toggle) return;

  if (state.inventory[i].dropdown) {
    area.classList.add("open");
    toggle.innerText = "▲";
  } else {
    area.classList.remove("open");
    toggle.innerText = "▼";
  }
}

function chgCounter(i, c, d) {
  state.inventory[i].counters[c].value =
    Math.max(0, state.inventory[i].counters[c].value + d);
  save();
  const el = document.getElementById(`count${i}_${c}`);
  if (el) el.innerText = state.inventory[i].counters[c].value;
}

// ---------- ARMOR DAMAGE ----------

function applyArmorDamage(raw) {
  const match = raw.match(/^(\d+)([PNXR])$/);
  if (!match) return;

  const amount = parseInt(match[1]);
  const type = match[2];

  const armorMap = {
    P: "Physical",
    N: "Energy",
    X: "Explosive",
    R: "Rad"
  };

  const armorType = armorMap[type];
  const armorValue = parseInt(state.armor[armorType]) || 0;

  let damage = amount - armorValue;
  if (damage < 0) damage = 0;

  let { cur, max } = parseHP();
  cur = Math.max(0, cur - damage);

  state.hp = `${cur}/${max}`;
  updateHPDisplay();
  updateHPColor();
  save();
}

// ---------- PERK DATA ----------

const perkData = {
  STRENGTH: [
    { name: "Strong Back", desc: "You can hold +2 heavy items and cannot be shoved or grappled." },
    { name: "Juggernaut", desc: "Melee attacks do +1 damage after sprinting." },
    { name: "Artisan", desc: "Repairing a broken item gives it +1 durability." },
    { name: "Pitcher", desc: "Thrown weapons and grenades do +1 damage at max range." },
    { name: "Wrecking Ball", desc: "Melee aimed shots can shove the target 1 tile in any direction." },
    { name: "Carnivore", desc: "Consuming flesh gives an extra -1 hunger and heals 10% HP." },
    { name: "Big Justice", desc: "Explosive splash damage aimed shots splash to short range." },
    { name: "Chain Reaction", desc: "Explosive damage kills cause the target to explode." },
    { name: "Chiropractor", desc: "When you cripple a limb, you can cripple another different limb." },
    { name: "Bear Hug", desc: "Melee aimed shots can grapple the target until your next turn." },
    { name: "Boomer", desc: "Explosive guns do +1 damage and always detonate explosive tiles." },
    { name: "Heavy Metal", desc: "Gain +1 energy armor for each heavy item you have." }
  ],

  AGILITY: [
    { name: "Commando", desc: "Rifles do +1 damage when fired from cover." },
    { name: "Gunslinger", desc: "Pistol attacks can spend your movement to do +1 damage." },
    { name: "Sixth Sense", desc: "You can also move or sprint when you defend or search." },
    { name: "Gotta Go Fast", desc: "Sprint moves +1 distance and lets you ignore ground hazards." },
    { name: "Ninja", desc: "You can move while sneaking and sneak attack kills do not reveal you." },
    { name: "Guerrilla", desc: "Special terrain also counts as cover and attacks ignore obstructions." },
    { name: "Sniper", desc: "Long range weapons gain +1 range and ignore cover." },
    { name: "Perfectionist", desc: "Crits restore luck, heal 10% HP, and deal +1 damage if attacking." },
    { name: "Jack of All Trades", desc: "Gain another skill that uses stats different from your skill." },
    { name: "Good Karma", desc: "Tag an additional stat. Critical fails now count as regular fails." },
    { name: "Rivers of Blood", desc: "Physical damage aimed shots can cause the target to bleed." },
    { name: "Gun Fu", desc: "Gain +1 physical armor for each enemy in melee range." }
  ],

  ENDURANCE: [
    { name: "Blacksmith", desc: "Consume one fewer scrap when you roll a success on a repair roll." },
    { name: "Iron Man", desc: "Gain +10 max HP and your limbs can only be crippled once each." },
    { name: "Lead Belly", desc: "Treat irradiated food and drink as dirty instead." },
    { name: "Sadist", desc: "Aimed shots that apply ailments add +1 stack to all ailments on the target." },
    { name: "All-nighter", desc: "You can gain +1 fatigue to scavenge a settlement." },
    { name: "Chromomancer", desc: "Gain the ability to harvest mutant DNA to create a mutant." },
    { name: "Ghoulish", desc: "Heal 10% HP each time you gain one or more rads." },
    { name: "Perseverance", desc: "After you make a roll with a stat at 0 or 1, restore skill." },
    { name: "Rare Hunter", desc: "You can scavenge for special items directly." },
    { name: "Catch a Ride", desc: "When you move you can take an ally in melee range with you." },
    { name: "Shotgun Surgeon", desc: "Shotguns do +1 damage against enemies in melee range." },
    { name: "Exposure Therapy", desc: "Rad damage aimed shots can poison the target." }
  ],

  INTELLIGENCE: [
    { name: "Scrounger", desc: "Looting killed humans always yields an extra 5 caps." },
    { name: "Substance Enthusiast", desc: "Chems last twice as long and heal 10% HP on use." },
    { name: "Hoarder", desc: "You can use broken items but durability loss destroys them." },
    { name: "Discerning Eye", desc: "You can reroll the type of scavenging roll you get once each." },
    { name: "Idiot Savant", desc: "You can treat two rolled 1s as a 6." },
    { name: "Green Thumb", desc: "Potted plants have +100% yield if held for the whole level." },
    { name: "Side Hustle", desc: "Gain an additional background." },
    { name: "Test Subject", desc: "Artifacts can convert durability to or from your HP at a 1:10 ratio." },
    { name: "Robotics Expert", desc: "Gain the ability to hack and build robots." },
    { name: "Overclock", desc: "Energy damage aimed shots can cause the target to burn." },
    { name: "Chosen One", desc: "You understand alien technology and meds restore +10% HP." },
    { name: "Magnetic Field", desc: "Gain +1 rad armor for each technology you are holding." }
  ],

  CHARISMA: [
    { name: "Animal Friend", desc: "Gain the ability to pacify and befriend wild animals." },
    { name: "Do Not Go Gently", desc: "Luck gives +1 die when used on another player." },
    { name: "VIP Member", desc: "Sleeping in a settlement is free and twice as effective." },
    { name: "True Grit", desc: "Resist can be used on other players and always rolls at least 2 dice." },
    { name: "Wasteland’s Got Talent", desc: "You can perform a show in each settlement." },
    { name: "Selfless", desc: "You can intercept non aimed shot attacks against allies in melee range." },
    { name: "Vampire", desc: "You can drink the blood of recently deceased creatures." },
    { name: "I know a Place", desc: "Chosen faction settlements provide a free crit faction loot roll." },
    { name: "Cyberpsycho", desc: "You can have +2 implants and doctor services cost you 50% less." },
    { name: "Grifter", desc: "Haggling is twice as effective." },
    { name: "High Roller", desc: "You can treat any rolled triples as a 6." },
    { name: "Cool Guys Don’t Look at Explosions", desc: "Gain +5 explosive armor." }
  ]
};

const backgroundData = [
  { name: "Technician", desc: "Repairing weapons does not require a roll." },
  { name: "Mechanic", desc: "Repairing armor does not require a roll." },
  { name: "Farmer", desc: "You can purify rations 2:1 (irradiated → dirty → clean)." },
  { name: "Chef", desc: "You can convert any 2 flesh into 1 fuel." },
  { name: "Exterminator", desc: "You can instantly execute enemies within melee range with less HP than your level on your turn." },
  { name: "Guard", desc: "You can convert 2 small rounds ↔ 1 large round." },
  { name: "Plumber", desc: "You can purify water 2:1 (irradiated → dirty → clean)." },
  { name: "Doctor", desc: "You can convert any 2 meds into another med." },
  { name: "Scientist", desc: "You can convert any 2 chems into another chem." },
  { name: "Engineer", desc: "Repairing technology does not require a roll." },
  { name: "Tailor", desc: "You can convert any 2 scrap into another scrap." },
  { name: "Electrician", desc: "You can convert 2 E-cells ↔ 1 MF-cell." }
];


// ---------- PERKS UI ----------

function toggleSection(stat, header) {
  const list = header.nextElementSibling;
  const collapsed = header.classList.toggle("collapsed");
  list.classList.toggle("open");
  state.perkSections[stat] = !collapsed;
  save();
}

function buildPerkUI() {
  const container = document.querySelector(".perks-content");
  if (!container) return;
  container.innerHTML = "";
  
  const allPerksWrapper = document.createElement("div");
	allPerksWrapper.id = "allPerksWrapper";
	container.appendChild(allPerksWrapper);
	
	const specialWrapper = document.createElement("div");
specialWrapper.id = "specialWrapper";
container.appendChild(specialWrapper);

  Object.keys(perkData).forEach(stat => {
    const section = document.createElement("div");
    section.className = "perk-section";

    const isOpen = state.perkSections[stat] !== false;

    section.innerHTML = `
      <div class="perk-header ${isOpen ? "" : "collapsed"}"
           onclick="toggleSection('${stat}', this)">
        <span class="triangle">▼</span>
        <h3>${stat}</h3>
      </div>
      <div class="perk-list ${isOpen ? "open" : ""}"></div>
    `;

    const list = section.querySelector(".perk-list");

    perkData[stat].forEach(perk => {
      const id = `${stat}-${perk.name}`;
      const item = document.createElement("label");
      item.className = "perk-item";

      item.innerHTML = `
        <input type="checkbox" class="perk-check" data-id="${id}">
        <span class="perk-box"></span>
        <span class="perk-text"><b>${perk.name.toUpperCase()}:</b> ${perk.desc}</span>
      `;

      if (state.perks[id]) {
        item.querySelector(".perk-check").checked = true;
      }

      list.appendChild(item);
    });

    specialWrapper.appendChild(section);
  });
  
		// BACKGROUNDS HEADER
	const bgHeader = document.createElement("h2");
	bgHeader.className = "major-header";
	bgHeader.innerHTML = `<span class="triangle">▼</span> BACKGROUNDS`;
	container.appendChild(bgHeader);

	// BACKGROUNDS LIST (always visible)
	const bgListWrapper = document.createElement("div");
	bgListWrapper.id = "backgroundsWrapper";
	bgListWrapper.className = "perk-list open";
	container.appendChild(bgListWrapper);

	// Add each background directly
	backgroundData.forEach(bg => {
	  const id = `Background-${bg.name}`;
	  const item = document.createElement("label");
	  item.className = "perk-item";

  item.innerHTML = `
    <input type="checkbox" class="perk-check" data-id="${id}">
    <span class="perk-box"></span>
    <span class="perk-text"><b>${bg.name.toUpperCase()}:</b> ${bg.desc}</span>
  `;

  if (state.perks[id]) {
    item.querySelector(".perk-check").checked = true;
  }

  bgListWrapper.appendChild(item);
});

// Restore saved collapse state
if (state.perkSections["Backgrounds"] === false) {
  bgListWrapper.classList.remove("open");
  bgHeader.classList.add("collapsed");
}

// Attach collapse handler
bgHeader.onclick = () => toggleBackgrounds(bgHeader);

	// RECIPES & NOTES HEADER
	const notesHeader = document.createElement("h2");
	notesHeader.className = "major-header";
	notesHeader.id = "notesHeader"; // ← ADD THIS
	notesHeader.innerHTML = `<span class="triangle">▼</span> RECIPES & NOTES`;
	container.appendChild(notesHeader);

	// WRAPPER FOR TEXT AREA
	const notesWrapper = document.createElement("div");
	notesWrapper.id = "notesWrapper";
	notesWrapper.className = "perk-list open"; // starts open
	container.appendChild(notesWrapper);

	// TEXT AREA
	const notesBox = document.createElement("textarea");
	notesBox.id = "notesBox";
	notesBox.style.width = "100%";
	notesBox.style.height = "100%";
	notesBox.style.background = "#081408";
	notesBox.style.color = "#9fef9f";
	notesBox.style.border = "1px solid #2cff2c";
	notesBox.style.padding = "8px";
	notesBox.style.fontFamily = "monospace";
	notesBox.style.boxSizing = "border-box";

	// Load saved text
	notesBox.value = state.notes || "";

	// Save on input
	notesBox.addEventListener("input", () => {
	  state.notes = notesBox.value;
	  save();
	});

	notesWrapper.appendChild(notesBox);

	// Restore collapse state
	if (state.perkSections["NOTES"] === false) {
	  notesWrapper.classList.remove("open");
	  notesHeader.classList.add("collapsed");
	}

	// Attach collapse handler
	notesHeader.onclick = () => toggleNotes(notesHeader);



  // Hook up checkbox change → save
  container.querySelectorAll(".perk-check").forEach(box => {
    box.addEventListener("change", () => {
      const id = box.dataset.id;
      state.perks[id] = box.checked;
      save();
    });
  });


}

function toggleNotes(header) {
  const wrap = document.getElementById("notesWrapper");
  const collapsed = wrap.classList.toggle("open") === false;

  header.classList.toggle("collapsed", collapsed);

  state.perkSections["NOTES"] = !collapsed;
  save();
}


function toggleBackgrounds(header) {
  const list = document.getElementById("backgroundsWrapper");
  const collapsed = list.classList.toggle("open") === false;

  header.classList.toggle("collapsed", collapsed);

  state.perkSections["Backgrounds"] = !collapsed;
  save();
}
 

function togglePerks() {
  const wrap = document.getElementById("specialWrapper");
  const title = document.getElementById("perksTitle");

  const collapsed = wrap.classList.toggle("collapsed");
  title.classList.toggle("collapsed", collapsed);

  state.perkSections["SPECIAL_ALL"] = !collapsed;
  save();
}



// ---------- SCREEN SWITCHING ----------

function showPerksScreen() {
  buildPerkUI();
  document.getElementById("perksScreen").style.display = "block";
  window.scrollTo(0, 0);
}

function hidePerksScreen() {
  document.getElementById("perksScreen").style.display = "none";
  window.scrollTo(0, 0);

}

// ---------- INIT ----------

function init() {
  // Front page fields
  name.value = state.name;
  skillName.value = state.skillName;
  level.value = state.level;
  caps.value = state.caps;

  document.getElementById("perksBtn").onclick = showPerksScreen;
  document.getElementById("backBtn").onclick = hidePerksScreen;
  document.getElementById("perksTitle").onclick = togglePerks;

  name.oninput = e => { state.name = e.target.value; save(); };
  skillName.oninput = e => { state.skillName = e.target.value; save(); };
  level.oninput = e => { state.level = e.target.value; save(); };
  caps.oninput = e => { state.caps = e.target.value; save(); };

  updateHPDisplay();
  updateHPColor();

  hp.oninput = e => {
    state.hp = e.target.value;
    save();
  };

  // Stats
const statsDiv = document.getElementById("stats");
statsDiv.innerHTML = "";

statNames.forEach(s => {

  // 1. Build the stat row
  statsDiv.innerHTML +=
    `<div class='card stat-box center'>
       <b onclick="toggleStatStar(this)"
          data-stat="${s}"
          style="cursor:pointer;">${s}</b>
       <input class="stat-input" value='${state.stats[s]}'
         oninput="state.stats['${s}']=this.value;save();">
     </div>`;


  const label = statsDiv.querySelector(`b[data-stat="${s}"]`);

  if (state.starredStats && state.starredStats[s]) {
    // restore gold + stars
    label.dataset.base = s;
    label.dataset.starred = "true";
    label.textContent = `${s}`;
    label.classList.add("stat-starred");

    // optional: goldify number box too
    const box = label.parentElement.querySelector(".stat-input");
    if (box) box.classList.add("stat-starred");

  } else {
    label.dataset.starred = "false";
  }
});

	


  // Armor
  const armorDiv = document.getElementById("armor");
  armorDiv.innerHTML = "";
  armorTypes.forEach(([label, c]) => {
    armorDiv.innerHTML +=
      `<div class='armor-box ${c}-theme'>
         <b class='armor-label'>${label.toUpperCase()}</b>
         <input value='${state.armor[label]}'
           oninput="state.armor['${label}']=this.value;save();">
       </div>`;
  });

  // Negatives
  const negDiv = document.getElementById("negatives");
  negDiv.innerHTML = "";
  negNames.forEach(n => {
    negDiv.innerHTML +=
      `<div class='card neg-card'>
         <b>${n.toUpperCase()}</b>
         <div id='${n}' class='neg-value'>${state.neg[n]}</div>
         <div class='neg-btn-row'>
           <button class='neg-btn' onclick="chgNeg('${n}',-1)">−</button>
           <button class='neg-btn' onclick="chgNeg('${n}',1)">+</button>
         </div>
       </div>`;
  });
  
// COLORIZE STATUSES
negNames.forEach(n => {
  const val = state.neg[n];
  const el = document.getElementById(n);

  if (val >= 8) {
    el.style.color = "#ff4c4c";      // red
  } else if (val >= 6) {
    el.style.color = "#ff7f3f";      // HP orange (redder orange)
  } else if (val >= 4) {
    el.style.color = "#ffd84d";      // yellow
  } else {
    el.style.color = "";             // reset to default (green)
  }
});


 

  // Inventory
  const invDiv = document.getElementById("inventory");
  invDiv.innerHTML = "";
  state.inventory.forEach((it, i) => {
    invDiv.innerHTML +=
      `<div class='card slot'>
         <div class="slot-top">
           <div id="dropbtn${i}" class="dropdown-toggle" onclick="toggleDropdown(${i})">▼</div>
           <textarea rows='3'
             oninput="state.inventory[${i}].name=this.value;save();">${it.name}</textarea>
           <div id="heavy${i}" class="heavy-toggle" onclick="toggleHeavy(${i})"></div>
         </div>
         <div id="droparea${i}" class="dropdown-area"></div>
       </div>`;
  });

  state.inventory.forEach((it, i) => {
    renderHeavy(i);
    renderDropdown(i);
    const area = document.getElementById("droparea" + i);
    area.innerHTML = "";
    it.counters.forEach((c, j) => {
      area.innerHTML +=
        `<div class="card neg-card inv-counter-card">
           <input class="neg-title-input" type="text" value="${c.title}"
             oninput="state.inventory[${i}].counters[${j}].title=this.value;save();">
           <div class="inv-counter-btn-row">
             <button class="neg-btn inv-counter-btn" onclick="chgCounter(${i},${j},-1)">−</button>
             <div id="count${i}_${j}" class="inv-counter-value">${c.value}</div>
             <button class="neg-btn inv-counter-btn" onclick="chgCounter(${i},${j},1)">+</button>
           </div>
         </div>`;
    });
  });

  // Uses
  ["skill","luck","resist"].forEach(k => {
    const el = document.getElementById(
      "use" + k.charAt(0).toUpperCase() + k.slice(1)
    );
    function render() {
      el.className = "use-box " + (state.uses[k] ? "use-on" : "use-off");
    }
    el.onclick = () => { state.uses[k] = !state.uses[k]; save(); render(); };
    render();
  });

  // Addiction toggle
  const addictionEl = document.getElementById("addictionToggle");
  function renderAddiction() {
    addictionEl.className = "use-box addiction-box";
    if (state.addiction) {
      addictionEl.classList.add("use-off");
    }
  }
  addictionEl.onclick = () => {
    state.addiction = !state.addiction;
    save();
    renderAddiction();
  };
  renderAddiction();

  // Armor damage input
  const armorInput = document.getElementById("armorDmgInput");
  armorInput.addEventListener("input", () => {
    const raw = armorInput.value.trim().toUpperCase();
    const match = raw.match(/^(\d+)([PNXR])$/);
    if (!match) return;
    applyArmorDamage(raw);
    armorInput.value = "";
  });
}

function toggleStatStar(el) {
  const stat = el.dataset.stat;
  const box = el.parentElement.querySelector(".stat-input");

  if (el.dataset.starred === "true") {
    // unstar
    el.textContent = el.dataset.base;
    el.classList.remove("stat-starred");
    el.dataset.starred = "false";
    if (box) box.classList.remove("stat-starred");

    state.starredStats[stat] = false;

  } else {
    // star
    el.dataset.base = el.textContent;
    el.textContent = `${el.dataset.base}`;
    el.classList.add("stat-starred");
    el.dataset.starred = "true";
    if (box) box.classList.add("stat-starred");

    state.starredStats[stat] = true;
  }

  save();
}




function exportSheet() {
  const data = JSON.stringify(state, null, 2);
  const blob = new Blob([data], { type: "application/json" });
  const url = URL.createObjectURL(blob);

  const a = document.createElement("a");
  a.href = url;
  a.download = "character-sheet.json";
  a.click();

  URL.revokeObjectURL(url);
}

function importSheet() {
  const input = document.getElementById("fileInput");
  input.click();

  input.onchange = () => {
    const file = input.files[0];
    const reader = new FileReader();

    reader.onload = () => {
      try {
        const loaded = JSON.parse(reader.result);

        // Merge loaded data into your state
        Object.assign(state, loaded);

        // Save to localStorage
        save();

        // Rebuild UI to reflect loaded data
        buildPerkUI();

        alert("Sheet loaded successfully!");
      } catch (e) {
        alert("Invalid or corrupted file.");
      }
    };

    reader.readAsText(file);
  };
}


document.addEventListener("DOMContentLoaded", init);
</script>


</body>
</html>
